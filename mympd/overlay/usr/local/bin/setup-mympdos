#!/bin/sh
#
# SPDX-License-Identifier: GPL-2.0-or-later
# myMPD (c) 2018-2020 Juergen Mang <mail@jcgames.de>
# https://github.com/jcorporation/mympd
#
removeOverlay() {
  mount -o remount,rw /media/mmcblk0p1
  rm /media/mmcblk0p1/*.apkovl.tar.gz
  rm /media/mmcblk0p1/wifi.txt
  mount -o remount,ro /media/mmcblk0p1

  rc-update del local default
  rm /etc/local.d/mympdos.start
}

#Remount data partion rw and create directories
mount -oremount,rw /media/mmcblk0p2
install -d /media/mmcblk0p2/apkcache

#Prevent clock warnings
rc-update add swclock boot    # enable the software clock
rc-update del hwclock boot    # disable the hardware clock

#Setup alpine
echo "Please set a secure root password"
while ! passwd
do
  echo "Error setting password"
done
setup-keymap
setup-apkcache /media/mmcblk0p2/apkcache
setup-ntp -c busybox
echo "LBU_MEDIA=mmcblk0p2" > /etc/lbu/lbu.conf

echo "Available MPD versions"
echo "  1. MPD 21.x (stable) (default)"
echo "  2. MPD 22.x (unstable"
read -n1 -r -p "Select: " MPD_VERSION
if [ "$MPD_VERSION" != "1" ] && [ "$MPD_VERSION" != "2" ]
then
  MPD_VERSION=1
fi

#add mympd-os local repository
cp /media/mmcblk0p1/mympd-os-apks/*.rsa.pub /etc/apk/keys/
echo "/media/mmcblk0p1/mympd-os-apks" >> /etc/apk/repositories

#enable community repository and upgrade
sed -r -e's/^#(.*\d\/community)/\1/' -i /etc/apk/repositories
apk upgrade

#add aditional software
if [ "$MPD_VERSION" = "1" ]
then
  apk add mympd-os-mpd-stable
else
  apk add mympd-os-mpd-master
fi
apk add rng-tools mympd mpc sudo
rc-update add rngd boot
rc-update add urandom boot

#Music library on sdcard
install -d /media/mmcblk0p2/library -o mpd -g mpd -m 775
adduser mympd mpd

#Tag cache direcory to support mpd mounts
install -d /var/lib/mpd/cache -o mpd -g mpd

cat >> /etc/sudoers <<EOL
Cmnd_Alias MYMPD_CMDS = /media/mmcblk0p2/scripts/savereboot.sh, /media/mmcblk0p2/scripts/saveshutdown.sh /media/mmcblk0p2/scripts/rwlibrary.sh
mympd ALL=NOPASSWD: MYMPD_CMDS
EOL

#Copy default settings
cp /usr/local/defaults/lua/*.lua /var/lib/mympd/scripts/
cp -r /usr/local/defaults/scripts /media/mmcblk0p2/
cp /usr/local/defaults/mpd.conf /etc/
cp /usr/local/defaults/mympd.conf /etc/

#change motd
read VERSION < "/media/mmcblk0p1/myMPDos.version"
cat > /etc/motd << EOL
Welcome to myMPDos ${VERSION}!

myMPDos is based on Alpine Linux.

myMPDos: <https://github.com/jcorporation/myMPDos>

Enjoy the music!

EOL

#Remove overlay and save changes
removeOverlay
LBU_INCLUDES="/var/lib/mympd /var/lib/mpd /usr /etc/init.d"
for INCLUDE in "$LBU_INCLUDES"
do
  lbu_include "$INCLUDE"
done
lbu_commit
mount -oremount,rw /media/mmcblk0p2
echo "Finished installing myMPDos."
echo "Enjoy the music!"
echo ""
