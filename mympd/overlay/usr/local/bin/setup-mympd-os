#!/bin/sh
#
# SPDX-License-Identifier: GPL-2.0-or-later
# myMPD (c) 2018-2020 Juergen Mang <mail@jcgames.de>
# https://github.com/jcorporation/mympd
#
removeOverlay() {
  mount -o remount,rw /media/mmcblk0p1
  rm /media/mmcblk0p1/*.apkovl.tar.gz
  rm /media/mmcblk0p1/wifi.txt
  mount -o remount,ro /media/mmcblk0p1

  rc-update del local default
  rm /etc/local.d/headless.start
}

#Prevent clock warnings
rc-update add swclock boot    # enable the software clock
rc-update del hwclock boot    # disable the hardware clock

#first setup alpine
setup-alpine

echo "Available MPD versions"
echo "  1. MPD 21.x (stable) (default)"
echo "  2. MPD 22.x (unstable"
read -n1 -r -p "Select: " MPD_VERSION
if [ "$MPD_VERSION" != "1" ] && [ "$MPD_VERSION" != "2" ]
then
  MPD_VERSION=1
fi

#add mympd-os local repository
cp /media/mmcblk0p1/mympd-os-apks/*.rsa.pub /etc/apk/keys/
echo "/media/mmcblk0p1/mympd-os-apks" >> /etc/apk/repositories

#enable community repository and upgrade
sed -r -e's/^#(.*\d\/community)/\1/' -i /etc/apk/repositories
apk update
apk upgrade

#add aditional software
if [ "$MPD_VERSION" = "1" ]
then
  apk add mympd-os-mpd-stable
else
  apk add mympd-os-mpd-master
fi
apk add rng-tools mympd
rc-update add rngd boot
rc-update add wpa_supplicant boot
rc-update add urandom boot

#change motd
cat > /etc/motd << EOL
Welcome to myMPD-OS!

myMPD-OS is based on Alpine.

myMPD-OS: <https://jcorporation.github.io/myMPD/>
Alpine:   <https://alpinelinux.org/>

Enjoy the music!

EOL

#finished
removeOverlay
echo "Finished installing myMPD-OS."
echo "Enjoy the music!"
